# MicroPython Test Framework for UEFI

The MicroPython Test Framework for UEFI (`MpyTestFrameworkPkg`) is designed for firmware unit testing and validation. This framework provides a set of convenient abstractions designed to remove as much boilerplate as possible from firmware test configuration, case development, and test execution.

The framework leverages [MicroPython](https://micropython.org) for a lightweight and minimalist implementation. It is general enough to be useful in a variety of firmware testing scenarios including black box tests, white box tests, functional testing, and automating UI/human interaction.

## How to Build

This test framework is dependent on the MicroPython Interpreter for UEFI: [MicroPythonPkg](..\MicroPythonPkg). Please build `MicroPythonPkg` prior to compiling `MpyTestFrameworkPkg`.

### Download Required Tools
 * Install [Python27](https://www.python.org/) and set the `PYTHON_HOME` environment variable to the Python 2.7 installation directory (`C:\Python27`)
 * Install Maven, using the official site tutorial: [Installing Apache Maven](https://maven.apache.org/install.html)
 * Download `Chart.bundle.min.js` from the [ChartJS official site](https://github.com/chartjs/Chart.js/releases) and copy it to ```MpyTestFrameworkPkg\Report\resources\js```
 * Download `jquery-3.3.1.js` from the [JQuery official site](https://jquery.com/download/) and copy it to ```MpyTestFrameworkPkg\Report\resources\js```

### Compile

Use the following commands to compile the package
(examples below assume workspace directory is `C:\edk2`):

 ```
 C:\edk2> edksetup.bat
 C:\edk2> python setup.py VS2013 DEBUG
 ```
 For `setup.py`, the first parameter sets the compiler (`['VS2013', 'VS2015', 'VS2017']`) and the second parameter sets the build output type (`['DEBUG', 'RELEASE', 'NOOPT']`).
 The executable binary is located under `Build\MpyTest`.

### Currently supported EDK II tool chains

* `VS2013/VS2013x86`
* `VS2015/VS2015x86`
* `VS2017`

Additional toolchains will be supported in future releases.

## Setup

The following instructions configure the MicroPython Test Framework for UEFI to run from a USB Storage Device:

 1. Format the USB drive with a FAT32 file system. Change the drive label to 'MPTF'.
 * Copy the `MpyTest` directory and its contents to the root folder of the USB drive.
 * Create a sub-directory for test scripts named `Scripts` under the `MpyTest` folder.
 * Mount the media disk on the System Under Test (SUT) and boot the SUT to the UEFI shell.
 * Enter the `MpyTest` directory and execute `startup.nsh` to run the MicroPython Test Framework for UEFI.

## File Structure

The `MpyTest` folder contains the following:

 * `Bin`
   MicroPython Interpreter for UEFI, generated by `MicroPythonPkg`
 * `Config`
   The `Config` folder contains two `.json` files that determine the sequence of test cases, including execution order and running times. There are three defined types: `case`, `suite` and `suites`.
   * `Case` represents independent test scripts under the `Scripts` folder
   * `Suite` is a sequence of cases, defined via `Test_Suite.json`
   * `Suites` is a sequence of suites, defined via `Test_Suites.json`
 * `Doc`
   The Script Writing Guide for built-in API introduction.
 * `Lib`
   Task scheduler, built-in API, and Python wrapper for UEFI services.
 * `Log`
   Output logs of test cases are stored here.
 * `Tools`
   Provides a series of related tools. This includes a tool to parse log files and generate a human-readable test report.
   ```
   java -jar ReportGenerator-1.0-SNAPSHOT-jar-with-dependencies.jar
   ```
 * `Report`
   Location for generated reports and resources.
 * `Scripts`
   Some sample test cases are included in the `Scripts` folder by default. For normal operation, all test cases must be under this folder. Modifying and executing sample scripts is a good way to get familiar with the test framework.
* `startup.nsh`
   Launches the framework. Usage is described below:  
   ```
    startup.nsh [-h] [-a [ia32 | x64] [-d] [-t [script name]] [-s [sequence name]] ]
        -h   Help info
        -a   Load binary for ia32 platform or x64 platform. Besides -h, -a should be first parameter
        -c   Run a Test Case in Script folder
        -s   Run a Test Suite which has a sequence of Test Cases
        -ss  Run a sequences of Test Suite
        Note: Please specify the platform before other settings
    ```

## Getting Started on NT32

The NT32 environment can be used to evaluate the test framework.

1. Build the NT32 environment, based on the [Getting Started](https://github.com/tianocore/tianocore.githubio/wiki/Getting-Started-with-EDK-II) instructions from TianoCore.
* Copy `%WORKSPACE%\Build\MpyTest` to the same directory as `SecMain.exe`.
* Run NT32 from the workspace directory: `build run`
* After NT32 boots to the UEFI Shell environment, type the following commands to change the volume label for `FS0:`
    ```
     fS0:
     vol -n MPTF
    ```
* Enter the `MpyTest` directory to run the sample test cases:
  * Run the test case `nt32_shell_hii.py`:
      ```
      startup.nsh -a ia32 -c nt32_shell_hii.py
      ```
  * Run the test suite `nt32_test_cases` defined in `Test_Suite.json` under the `Config` folder:
     ```
      startup.nsh -a ia32 -s nt32_test_cases
     ```
  * Run the group of test suites `nt32_related_suites` defined in `Test_Suites.json` under `Config` folder:
     ```
      startup.nsh -a ia32 -ss nt32_related_suites
     ```
* Check the `Log` folder to verify test logs were properly generated.
* Generate a test report. This relies on Java and must be run from Microsoft Windows environment (not the UEFI Shell).
  * Open a Windows command prompt
  * Navigate to the `MpyTest\Tools` folder under the same directory as `SecMain.exe`.
  * Use the following command to generate a test report.
    ```
       java -jar ReportGenerator-1.0-SNAPSHOT-jar-with-dependencies.jar
    ```
 * Open the `MpyTest\Report` folder to review the generated report.
